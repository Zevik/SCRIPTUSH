<!DOCTYPE html>
<html dir="rtl" lang="he">
  <head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×™×•××Ÿ ××©×™××•×ª ××™× ×˜×¨××§×˜×™×‘×™</title>
    <!-- ×”×•×¡×¤×ª ×¡×¤×¨×™×™×ª Chart.js ×œ×’×¨×¤×™× -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      /* ×¢×™×¦×•×‘ ×‘×¡×™×¡×™ ×•×¨×¡×¤×•× ×¡×™×‘×™ ×¢× ×ª××™×›×” ××œ××” ×‘-RTL */
      body {
        font-family: 'Rubik', 'Arial', sans-serif;
        background-color: #f0f2f5;
        margin: 0;
        padding: 20px;
        color: #333;
        direction: rtl;
      }
      .container {
        max-width: 800px;
        margin: auto;
        background: #fff;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      }
      h1 {
        color: #1a73e8;
        text-align: center;
      }
      .task-list {
        list-style: none;
        padding: 0;
      }
      .task-item {
        display: flex;
        align-items: center;
        padding: 15px;
        border-bottom: 1px solid #ddd;
        transition: background-color 0.3s;
      }
      .task-item:last-child {
        border-bottom: none;
      }
      .task-item.completed {
        text-decoration: line-through;
        color: #888;
      }
      .task-item:hover {
        background-color: #f9f9f9;
      }
      .task-item input[type="checkbox"] {
        margin-left: 15px;
      }
      .task-content {
        flex-grow: 1;
      }
      .task-date {
        color: #666;
        font-size: 0.85em;
        margin-right: 8px;
      }
      .task-actions {
        margin-right: auto;
        display: flex;
      }
      .task-actions button {
        background: none;
        border: none;
        cursor: pointer;
        color: #666;
        margin-right: 8px;
        font-size: 18px;
        transition: color 0.3s;
      }
      .task-actions button:hover {
        color: #e53935;
      }
      .btn {
        padding: 10px 15px;
        background-color: #1a73e8;
        color: white;
        border: none;
        border-radius: 5px;
        font-size: 16px;
        cursor: pointer;
        transition: background-color 0.3s;
      }
      .btn:hover {
        background-color: #1558b3;
      }
      .btn-danger {
        background-color: #e53935;
      }
      .btn-danger:hover {
        background-color: #c62828;
      }
      
      .task-input-container {
        display: flex;
        flex-wrap: wrap;
        margin-bottom: 20px;
        gap: 10px;
      }
      .task-input-container input[type="text"] {
        flex: 1;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 16px;
        min-width: 200px;
      }
      .task-input-container input[type="date"] {
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 16px;
      }
      
      .task-filters {
        display: flex;
        justify-content: center;
        margin-bottom: 20px;
        gap: 10px;
      }
      .task-filters button {
        padding: 8px 15px;
        background-color: #f5f5f5;
        border: 1px solid #ddd;
        border-radius: 5px;
        cursor: pointer;
      }
      .task-filters button.active {
        background-color: #1a73e8;
        color: white;
        border-color: #1a73e8;
      }
      
      .task-stats {
        display: flex;
        justify-content: space-around;
        background-color: #f5f5f5;
        padding: 15px;
        border-radius: 5px;
        margin-top: 30px;
        margin-bottom: 20px;
      }
      .stat-box {
        text-align: center;
      }
      .stat-number {
        font-size: 24px;
        font-weight: bold;
        color: #1a73e8;
      }
      
      /* ×—×œ×§ ×”×’×¨×¤×™× */
      .charts-section {
        margin-top: 30px;
        padding: 20px;
        background-color: #f9f9f9;
        border-radius: 8px;
      }
      .chart-container {
        margin: 15px 0;
        position: relative;
        height: 250px;
      }
      .chart-tabs {
        display: flex;
        justify-content: center;
        margin-bottom: 15px;
      }
      .chart-tab {
        padding: 8px 15px;
        margin: 0 5px;
        background-color: #e0e0e0;
        border-radius: 5px;
        cursor: pointer;
        transition: all 0.3s;
      }
      .chart-tab.active {
        background-color: #1a73e8;
        color: white;
      }
      
      /* ×¤×¢×™×œ×•×™×•×ª ×—×•×–×¨×•×ª */
      .recurring-tasks {
        margin-top: 30px;
        padding: 15px;
        background-color: #e8f5e9;
        border-radius: 8px;
      }
      .recurring-tasks h3 {
        margin-top: 0;
        color: #2e7d32;
      }
      .recurring-suggestion {
        display: flex;
        align-items: center;
        margin: 10px 0;
        padding: 10px;
        background-color: #fff;
        border-radius: 5px;
        cursor: pointer;
        transition: all 0.3s;
      }
      .recurring-suggestion:hover {
        background-color: #f0f9f0;
        transform: translateY(-2px);
      }
      .recurring-suggestion span {
        flex-grow: 1;
      }
      .recurring-icon {
        font-size: 20px;
        margin-left: 10px;
        color: #4caf50;
      }
      
      /* ×”×’×“×¨×•×ª ×ª×’ */
      .task-tags {
        display: flex;
        flex-wrap: wrap;
        margin-top: 5px;
      }
      .task-tag {
        font-size: 12px;
        padding: 3px 8px;
        border-radius: 12px;
        margin-left: 5px;
        margin-bottom: 5px;
        background-color: #e3f2fd;
        color: #1565c0;
      }
      .task-tag.high {
        background-color: #ffebee;
        color: #c62828;
      }
      .task-tag.medium {
        background-color: #fff8e1;
        color: #f57f17;
      }
      .task-tag.low {
        background-color: #e8f5e9;
        color: #2e7d32;
      }
      
      /* ×¡×™××•×Ÿ ×§×˜×’×•×¨×™×•×ª */
      .category-select {
        margin-top: 10px;
        width: 100%;
        padding: 8px;
        border-radius: 5px;
        border: 1px solid #ddd;
      }
      
      /* ××•×“×œ×™× ×—×“×©×™× */
      .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1000;
      }
      .modal-container {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: white;
        padding: 20px;
        border-radius: 8px;
        max-width: 90%;
        width: 500px;
        z-index: 1001;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      }
      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid #eee;
        padding-bottom: 10px;
        margin-bottom: 15px;
      }
      .modal-close {
        background: none;
        border: none;
        font-size: 20px;
        cursor: pointer;
        color: #999;
      }
      
      /* ××¦×‘×™ ×¨×•×— ×•××•×˜×™×‘×¦×™×” */
      .mood-tracker {
        display: flex;
        justify-content: space-around;
        margin: 20px 0;
      }
      .mood-icon {
        font-size: 24px;
        cursor: pointer;
        padding: 10px;
        border-radius: 50%;
        transition: all 0.3s;
      }
      .mood-icon:hover, .mood-icon.selected {
        background-color: #e3f2fd;
        transform: scale(1.2);
      }
      
      /* ×”×•×“×¢×•×ª ××¢×¨×›×ª */
      .message-box {
        display: none;
        padding: 15px;
        margin: 15px 0;
        border-radius: 5px;
        text-align: center;
        animation: fadeIn 0.5s;
      }
      .message-box.success {
        background-color: #e8f5e9;
        color: #2e7d32;
        border-left: 5px solid #2e7d32;
      }
      .message-box.error {
        background-color: #ffebee;
        color: #c62828;
        border-left: 5px solid #c62828;
      }
      
      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }
      
      /* ×¢×™×¦×•×‘ ×¨×¡×¤×•× ×¡×™×‘×™ ×œ××¡×›×™× ×§×˜× ×™× */
      @media (max-width: 600px) {
        body {
          padding: 10px;
        }
        .container {
          padding: 15px;
        }
        .task-filters {
          flex-direction: column;
        }
        .task-actions {
          margin-top: 10px;
          justify-content: flex-start;
        }
        .task-date {
          display: block;
          margin-top: 5px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>×™×•××Ÿ ×”××©×™××•×ª ×”××™× ×˜×¨××§×˜×™×‘×™ ×©×œ×™</h1>
      
      <!-- ×”×•×“×¢×•×ª ××¢×¨×›×ª -->
      <div id="messageBox" class="message-box"></div>
      
      <!-- ××¦×‘ ×¨×•×— ×•××•×˜×™×‘×¦×™×” ×™×•××™×ª -->
      <div class="mood-tracker">
        <div class="mood-icon" onclick="setMood('ğŸ˜Š')" title="×©××—">ğŸ˜Š</div>
        <div class="mood-icon" onclick="setMood('ğŸ˜')" title="×¨×’×™×œ">ğŸ˜</div>
        <div class="mood-icon" onclick="setMood('ğŸ˜')" title="×¢×¦×•×‘">ğŸ˜</div>
        <div class="mood-icon" onclick="setMood('ğŸ˜¤')" title="××ª×•×¡×›×œ">ğŸ˜¤</div>
        <div class="mood-icon" onclick="setMood('ğŸš€')" title="××•×˜×™×‘×¦×™×” ×’×‘×•×”×”">ğŸš€</div>
      </div>
      
      <!-- ×˜×•×¤×¡ ×”×•×¡×¤×ª ××©×™××” -->
      <div class="task-input-container">
        <input type="text" id="newTaskInput" placeholder="×”×•×¡×£ ××©×™××” ×—×“×©×”..." />
        <input type="date" id="newTaskDate" />
        <select id="taskPriority" class="category-select">
          <option value="low">×¢×“×™×¤×•×ª × ××•×›×”</option>
          <option value="medium" selected>×¢×“×™×¤×•×ª ×‘×™× ×•× ×™×ª</option>
          <option value="high">×¢×“×™×¤×•×ª ×’×‘×•×”×”</option>
        </select>
        <select id="taskCategory" class="category-select">
          <option value="general">×›×œ×œ×™</option>
          <option value="work">×¢×‘×•×“×”</option>
          <option value="personal">××™×©×™</option>
          <option value="health">×‘×¨×™××•×ª</option>
          <option value="education">×œ×™××•×“×™×</option>
        </select>
        <button class="btn" onclick="addNewTask()">×”×•×¡×£</button>
      </div>
      
      <!-- ×¡×™× ×•×Ÿ ××©×™××•×ª -->
      <div class="task-filters">
        <button id="filterAll" class="active" onclick="filterTasks('all')">×”×›×œ</button>
        <button id="filterActive" onclick="filterTasks('active')">×¤×¢×™×œ×•×ª</button>
        <button id="filterCompleted" onclick="filterTasks('completed')">×”×•×©×œ××•</button>
        <button id="filterCategory" onclick="openCategoryFilterModal()">×¡× ×Ÿ ×œ×¤×™ ×§×˜×’×•×¨×™×”</button>
      </div>
      
      <!-- ×¨×©×™××ª ××©×™××•×ª -->
      <ul id="taskList" class="task-list">
        <!-- ××©×™××•×ª ×™×ª×•×•×¡×¤×• ×›××Ÿ ×“×™× ××™×ª -->
      </ul>
      
      <!-- ×›×¤×ª×•×¨×™ × ×™×”×•×œ ××©×™××•×ª -->
      <div style="display: flex; justify-content: space-between; margin-top: 20px;">
        <button class="btn" onclick="saveTasksToFile()">×™×¦×•× ××©×™××•×ª</button>
        <button class="btn" onclick="openRecurringTasksModal()">×¤×¢×™×œ×•×™×•×ª ×—×•×–×¨×•×ª</button>
        <button class="btn btn-danger" onclick="clearCompletedTasks()">××—×§ ××©×™××•×ª ×©×”×•×©×œ××•</button>
      </div>
      
      <!-- ×¡×˜×˜×™×¡×˜×™×§×•×ª ××©×™××•×ª -->
      <div class="task-stats">
        <div class="stat-box">
          <div class="stat-number" id="totalTasks">0</div>
          <div>×¡×”"×› ××©×™××•×ª</div>
        </div>
        <div class="stat-box">
          <div class="stat-number" id="completedTasks">0</div>
          <div>×”×•×©×œ××•</div>
        </div>
        <div class="stat-box">
          <div class="stat-number" id="pendingTasks">0</div>
          <div>×‘×ª×”×œ×™×š</div>
        </div>
      </div>
      
      <!-- ××“×•×¨ ×”×’×¨×¤×™× -->
      <div class="charts-section">
        <h2>× ×™×ª×•×— × ×ª×•× ×™× ×•×”×ª×§×“××•×ª</h2>
        
        <div class="chart-tabs">
          <div class="chart-tab active" onclick="showChart('progress')">×”×ª×§×“××•×ª ×©×‘×•×¢×™×ª</div>
          <div class="chart-tab" onclick="showChart('categories')">×”×ª×¤×œ×’×•×ª ×§×˜×’×•×¨×™×•×ª</div>
          <div class="chart-tab" onclick="showChart('priorities')">×¢×“×™×¤×•×™×•×ª</div>
        </div>
        
        <div class="chart-container">
          <canvas id="progressChart"></canvas>
          <canvas id="categoriesChart" style="display: none;"></canvas>
          <canvas id="prioritiesChart" style="display: none;"></canvas>
        </div>
      </div>
      
      <!-- ×”×¦×¢×•×ª ×œ×¤×¢×™×œ×•×™×•×ª ×—×•×–×¨×•×ª -->
      <div class="recurring-tasks">
        <h3>×”×¦×¢×•×ª ×œ×¤×¢×™×œ×•×™×•×ª ×—×•×–×¨×•×ª</h3>
        <div id="recurringTasksList">
          <!-- ×”×¦×¢×•×ª ×œ×¤×¢×™×œ×•×™×•×ª ×—×•×–×¨×•×ª ×™×ª×•×•×¡×¤×• ×›××Ÿ ×“×™× ××™×ª -->
        </div>
      </div>
    </div>
    
    <!-- ××•×“×œ ×¤×¢×™×œ×•×™×•×ª ×—×•×–×¨×•×ª -->
    <div id="recurringTasksModal" class="modal-overlay">
      <div class="modal-container">
        <div class="modal-header">
          <h3>×”×’×“×¨×ª ×¤×¢×™×œ×•×ª ×—×•×–×¨×ª</h3>
          <button class="modal-close" onclick="closeModal('recurringTasksModal')">&times;</button>
        </div>
        <div>
          <input type="text" id="recurringTaskName" placeholder="×©× ×”××©×™××”" style="width: 100%; padding: 8px; margin-bottom: 10px;">
          <select id="recurringFrequency" style="width: 100%; padding: 8px; margin-bottom: 10px;">
            <option value="daily">×™×•××™</option>
            <option value="weekly">×©×‘×•×¢×™</option>
            <option value="monthly">×—×•×“×©×™</option>
          </select>
          <select id="recurringCategory" style="width: 100%; padding: 8px; margin-bottom: 15px;">
            <option value="general">×›×œ×œ×™</option>
            <option value="work">×¢×‘×•×“×”</option>
            <option value="personal">××™×©×™</option>
            <option value="health">×‘×¨×™××•×ª</option>
            <option value="education">×œ×™××•×“×™×</option>
          </select>
          <button class="btn" style="width: 100%;" onclick="addRecurringTask()">×”×•×¡×£ ×¤×¢×™×œ×•×ª ×—×•×–×¨×ª</button>
        </div>
      </div>
    </div>
    
    <!-- ××•×“×œ ×¡×™× ×•×Ÿ ×œ×¤×™ ×§×˜×’×•×¨×™×” -->
    <div id="categoryFilterModal" class="modal-overlay">
      <div class="modal-container">
        <div class="modal-header">
          <h3>×¡×™× ×•×Ÿ ×œ×¤×™ ×§×˜×’×•×¨×™×”</h3>
          <button class="modal-close" onclick="closeModal('categoryFilterModal')">&times;</button>
        </div>
        <div id="categoryFilterOptions">
          <div style="margin-bottom: 10px;">
            <input type="checkbox" id="categoryGeneral" checked>
            <label for="categoryGeneral">×›×œ×œ×™</label>
          </div>
          <div style="margin-bottom: 10px;">
            <input type="checkbox" id="categoryWork" checked>
            <label for="categoryWork">×¢×‘×•×“×”</label>
          </div>
          <div style="margin-bottom: 10px;">
            <input type="checkbox" id="categoryPersonal" checked>
            <label for="categoryPersonal">××™×©×™</label>
          </div>
          <div style="margin-bottom: 10px;">
            <input type="checkbox" id="categoryHealth" checked>
            <label for="categoryHealth">×‘×¨×™××•×ª</label>
          </div>
          <div style="margin-bottom: 15px;">
            <input type="checkbox" id="categoryEducation" checked>
            <label for="categoryEducation">×œ×™××•×“×™×</label>
          </div>
          <button class="btn" style="width: 100%;" onclick="applyCategoryFilter()">×”×—×œ ×¡×™× ×•×Ÿ</button>
        </div>
      </div>
    </div>

    <script>
      // ××¢×¨×š ×”××©×™××•×ª
      let tasks = [];
      let currentFilter = 'all';
      let selectedCategories = ['general', 'work', 'personal', 'health', 'education'];
      let currentMood = null;
      let recurringTasks = [];
      let charts = {};
      let activeChart = 'progress';
      let isLoading = true;
      
      // ×˜×¢×™× ×ª ××©×™××•×ª ×‘×˜×¢×™× ×ª ×”×“×£
      document.addEventListener('DOMContentLoaded', () => {
        showLoading(true);
        
        console.log('××ª×—×™×œ ×˜×¢×™× ×ª ××©×™××•×ª ××”×©×¨×ª...');
        
        // ×× ×’× ×•×Ÿ × ×™×¡×™×•× ×•×ª ×—×•×–×¨×™×
        let retryCount = 0;
        const maxRetries = 3;
        
        function loadTasksWithRetry() {
          // ×‘×“×™×§×ª ×”×—×™×‘×•×¨ ×ª×—×™×œ×”
          google.script.run
            .withSuccessHandler(function(connectionResult) {
              console.log('×‘×“×™×§×ª ×—×™×‘×•×¨:', connectionResult);
              
              // ×˜×¢×™× ×ª ×”××©×™××•×ª ××”×©×¨×ª (Google Sheets)
              google.script.run
                .withSuccessHandler(function(loadedTasks) {
                  console.log('×”×ª×§×‘×œ×• ××©×™××•×ª:', loadedTasks);
                  
                  // ×”×’×“×¨×ª ×”××©×™××•×ª - ×¢×™×‘×•×“ ×™×•×ª×¨ ××§×™×£ ×©×œ ×”×ª×•×¦××•×ª
                  if (loadedTasks) {
                    console.log('××ª×—×™×œ ×¢×™×‘×•×“ ×”××©×™××•×ª...');
                    
                    // ×•×™×“×•× ×©×”×¢×¨×š ×”×•× ××¢×¨×š ×’× ×× ×”×’×™×¢ ×›××—×¨×•×–×ª JSON
                    try {
                      if (typeof loadedTasks === 'string') {
                        console.log('×××™×¨ ××—×¨×•×–×ª JSON ×œ××¢×¨×š');
                        loadedTasks = JSON.parse(loadedTasks);
                      }
                      
                      // ×•×™×“×•× ×©×–×” ××¢×¨×š
                      if (!Array.isArray(loadedTasks)) {
                        console.warn('×”×ª×•×¦××” ××™× ×” ××¢×¨×š:', loadedTasks);
                        if (loadedTasks && typeof loadedTasks === 'object') {
                          // × ×™×¡×™×•×Ÿ ×œ×”××™×¨ ××•×‘×™×™×§×˜ ×œ××¢×¨×š ×× ××¤×©×¨
                          loadedTasks = Object.values(loadedTasks);
                        } else {
                          loadedTasks = [];
                        }
                      }
                      
                      console.log('×œ×¤× ×™ ×¡×™× ×•×Ÿ:', loadedTasks.length, '××©×™××•×ª');
                      
                      // ×¡×™× ×•×Ÿ ×©×œ ×¢×¨×›×™× ×œ× ×ª×§×™× ×™×
                      loadedTasks = loadedTasks.filter((task, index) => {
                        if (!task || typeof task !== 'object') {
                          console.warn(`××©×™××” ${index} ×œ× ×ª×§×™× ×”:`, task);
                          return false;
                        }
                        if (!task.id || !task.text) {
                          console.warn(`××©×™××” ${index} ×—×¡×¨×” ×©×“×•×ª ×—×©×•×‘×™×:`, task);
                          return false;
                        }
                        return true;
                      });
                      
                      console.log('××—×¨×™ ×¡×™× ×•×Ÿ:', loadedTasks.length, '××©×™××•×ª ×ª×§×™× ×•×ª');
                    } catch (error) {
                      console.error('×©×’×™××” ×‘×¢×™×‘×•×“ ×”××©×™××•×ª:', error);
                      loadedTasks = [];
                    }
                    
                    if (loadedTasks.length > 0) {
                      console.log('××¢×“×›×Ÿ ××¢×¨×š ×”××©×™××•×ª ×¢×', loadedTasks.length, '××©×™××•×ª');
                      tasks = loadedTasks;
                      
                      console.log('×§×•×¨× ×œ×¤×•× ×§×¦×™×™×ª renderTasks');
                      renderTasks();
                      
                      console.log('××¢×“×›×Ÿ ×¡×˜×˜×™×¡×˜×™×§×•×ª');
                      updateTaskStats();
                      
                      console.log('×××ª×—×œ ×’×¨×¤×™×');
                      initializeCharts();
                      
                      console.log('××¢×“×›×Ÿ ×’×¨×¤×™×');
                      updateCharts();
                      
                      console.log('×××›×œ×¡ ×”×¦×¢×•×ª ××©×™××•×ª ×—×•×–×¨×•×ª');
                      populateRecurringTaskSuggestions();
                      
                      showMessage(`× ×˜×¢× ×• ${loadedTasks.length} ××©×™××•×ª ×‘×”×¦×œ×—×”`, 'success');
                      console.log('×”×˜×¢×™× ×” ×”×•×©×œ××” ×‘×”×¦×œ×—×”');
                      showLoading(false);
                    } else if (retryCount < maxRetries) {
                      retryCount++;
                      console.warn(`× ×™×¡×™×•×Ÿ ×˜×¢×™× ×” ${retryCount}/${maxRetries} × ×›×©×œ, ×× ×¡×” ×©×•×‘...`);
                      setTimeout(loadTasksWithRetry, 1000); // × ×¡×” ×©×•×‘ ××—×¨×™ ×©× ×™×”
                    } else {
                      console.error('×›×œ × ×™×¡×™×•× ×•×ª ×”×˜×¢×™× ×” × ×›×©×œ×•');
                      showMessage('×œ× × ××¦××• ××©×™××•×ª ×ª×§×™× ×•×ª ××—×¨×™ ××¡×¤×¨ × ×™×¡×™×•× ×•×ª', 'error');
                      tasks = [];
                      renderTasks();
                      updateTaskStats();
                      initializeCharts();
                      updateCharts();
                      populateRecurringTaskSuggestions();
                      showLoading(false);
                    }
                  } else {
                    if (retryCount < maxRetries) {
                      retryCount++;
                      console.warn(`× ×™×¡×™×•×Ÿ ×˜×¢×™× ×” ${retryCount}/${maxRetries} × ×›×©×œ, ×× ×¡×” ×©×•×‘...`);
                      setTimeout(loadTasksWithRetry, 1000); // × ×¡×” ×©×•×‘ ××—×¨×™ ×©× ×™×”
                    } else {
                      console.warn('×œ× ×”×ª×§×‘×œ×• × ×ª×•× ×™× ××”×©×¨×ª ××—×¨×™ ××¡×¤×¨ × ×™×¡×™×•× ×•×ª');
                      showMessage('×œ× ×”×ª×§×‘×œ×• × ×ª×•× ×™× ××”×©×¨×ª, × ×¡×” ×œ×¨×¢× ×Ÿ ××ª ×”×“×£', 'error');
                      tasks = [];
                      renderTasks();
                      updateTaskStats();
                      initializeCharts();
                      updateCharts();
                      populateRecurringTaskSuggestions();
                      showLoading(false);
                    }
                  }
                })
                .withFailureHandler(function(error) {
                  console.error('×©×’×™××” ×‘×˜×¢×™× ×ª ×”××©×™××•×ª:', error);
                  
                  if (retryCount < maxRetries) {
                    retryCount++;
                    console.warn(`×©×’×™××” ×‘×˜×¢×™× ×” ${retryCount}/${maxRetries}, ×× ×¡×” ×©×•×‘...`);
                    setTimeout(loadTasksWithRetry, 1000); // × ×¡×” ×©×•×‘ ××—×¨×™ ×©× ×™×”
                  } else {
                    showMessage('×©×’×™××” ×‘×˜×¢×™× ×ª ×”××©×™××•×ª ××”×©×¨×ª: ' + error, 'error');
                    tasks = [];
                    renderTasks();
                    updateTaskStats();
                    initializeCharts();
                    updateCharts();
                    populateRecurringTaskSuggestions();
                    showLoading(false);
                  }
                })
                .loadTasksFromSheet();
            })
            .withFailureHandler(function(error) {
              console.error('×©×’×™××” ×‘×‘×“×™×§×ª ×”×—×™×‘×•×¨:', error);
              
              if (retryCount < maxRetries) {
                retryCount++;
                console.warn(`×©×’×™××” ×‘×—×™×‘×•×¨ ${retryCount}/${maxRetries}, ×× ×¡×” ×©×•×‘...`);
                setTimeout(loadTasksWithRetry, 1000); // × ×¡×” ×©×•×‘ ××—×¨×™ ×©× ×™×”
              } else {
                showMessage('×©×’×™××” ×‘×—×™×‘×•×¨ ×œ×©×¨×ª: ' + error, 'error');
                showLoading(false);
              }
            })
            .testConnection();
        }
        
        // ×”×ª×—×œ×ª ×”×˜×¢×™× ×” ×¢× × ×™×¡×™×•× ×•×ª ×—×•×–×¨×™×
        loadTasksWithRetry();
      });
      
      // ×”×¦×’×ª ×× ×™××¦×™×™×ª ×˜×¢×™× ×”
      function showLoading(show) {
        isLoading = show;
        if (show) {
          // ×™×¦×™×¨×ª ××œ×× ×˜ ×˜×¢×™× ×” ×× ×œ× ×§×™×™×
          if (!document.getElementById('loadingOverlay')) {
            const loadingOverlay = document.createElement('div');
            loadingOverlay.id = 'loadingOverlay';
            loadingOverlay.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(255,255,255,0.8); display: flex; justify-content: center; align-items: center; z-index: 9999;';
            
            const spinner = document.createElement('div');
            spinner.style.cssText = 'width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite;';
            
            // ×”×•×¡×¤×ª ×× ×™××¦×™×”
            const style = document.createElement('style');
            style.textContent = '@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }';
            document.head.appendChild(style);
            
            loadingOverlay.appendChild(spinner);
            document.body.appendChild(loadingOverlay);
          } else {
            document.getElementById('loadingOverlay').style.display = 'flex';
          }
        } else if (document.getElementById('loadingOverlay')) {
          document.getElementById('loadingOverlay').style.display = 'none';
        }
      }
      
      // ×¢×“×›×•×Ÿ ×•×©××™×¨×ª ×”××©×™××•×ª
      function saveTasks() {
        // ×‘×“×™×§×” ×× ×™×© ××” ×œ×©××•×¨
        if (!tasks || tasks.length === 0) {
          console.log('××™×Ÿ ××©×™××•×ª ×œ×©××•×¨');
          loadTasks(); // ×˜×¢×™× ×” ××—×“×© ×©×œ ×”××©×™××•×ª ××”×©×¨×ª ×‘××§×•× ×œ××—×•×§ ××ª ×”×›×œ
          return;
        }
        
        showLoading(true);
        console.log('×©×•××¨ ' + tasks.length + ' ××©×™××•×ª ×œ×©×¨×ª...');
        
        // ×©××™×¨×ª ×”××©×™××•×ª ×‘×©×¨×ª (Google Sheets)
        google.script.run
          .withSuccessHandler(function(success) {
            if (success) {
              console.log('×”××©×™××•×ª × ×©××¨×• ×‘×”×¦×œ×—×”');
              dataChanged = false; // ××™×¤×•×¡ ×¡××Ÿ ×”×©×™× ×•×™×™×
              updateTaskStats();
              updateCharts();
              showLoading(false);
              showMessage('×”××©×™××•×ª × ×©××¨×• ×‘×”×¦×œ×—×”', 'success');
            } else {
              showMessage('×©×’×™××” ×‘×©××™×¨×ª ×”××©×™××•×ª', 'error');
              showLoading(false);
            }
          })
          .withFailureHandler(function(error) {
            console.error('×©×’×™××” ×‘×©××™×¨×ª ×”××©×™××•×ª:', error);
            showMessage('×©×’×™××” ×‘×©××™×¨×ª ×”××©×™××•×ª ×œ×©×¨×ª', 'error');
            showLoading(false);
          })
          .saveTasksToSheet(tasks);
      }
      
      // ×˜×¢×™× ×ª ××©×™××•×ª ××—×“×©
      function loadTasks() {
        showLoading(true);
        console.log('×˜×•×¢×Ÿ ××©×™××•×ª ××”×©×¨×ª...');
        
        google.script.run
          .withSuccessHandler(function(loadedTasks) {
            console.log('×”×ª×§×‘×œ×• × ×ª×•× ×™× ××”×©×¨×ª:', loadedTasks);
            
            try {
              // ×˜×™×¤×•×œ ×‘×ª×•×¦××•×ª ×‘××§×¨×” ×©×”×Ÿ ×—×–×¨×• ×›××—×¨×•×–×ª
              if (typeof loadedTasks === 'string') {
                try {
                  loadedTasks = JSON.parse(loadedTasks);
                } catch (e) {
                  console.error('×©×’×™××” ×‘×¤×™×¨×•×¡ ×ª×•×¦××•×ª:', e);
                }
              }
              
              // ×•×™×“×•× ×©×”×ª×•×¦××” ×”×™× ××¢×¨×š
              if (!Array.isArray(loadedTasks)) {
                if (loadedTasks && typeof loadedTasks === 'object') {
                  loadedTasks = Object.values(loadedTasks);
                } else {
                  loadedTasks = [];
                }
              }
              
              // ×¡×™× ×•×Ÿ ×¢×¨×›×™× ×œ× ×ª×§×™× ×™×
              loadedTasks = loadedTasks.filter(task => task && typeof task === 'object' && task.id && task.text);
              
              tasks = loadedTasks;
              renderTasks();
              updateTaskStats();
              updateCharts();
              showLoading(false);
              
              if (tasks.length > 0) {
                showMessage(`× ×˜×¢× ×• ${tasks.length} ××©×™××•×ª ×‘×”×¦×œ×—×”`, 'success');
              } else {
                showMessage('×œ× × ××¦××• ××©×™××•×ª ×ª×§×™× ×•×ª', 'success');
              }
            } catch (error) {
              console.error('×©×’×™××” ×‘×¢×™×‘×•×“ ×”×ª×•×¦××•×ª:', error);
              showMessage('×©×’×™××” ×‘×¢×™×‘×•×“ ×”×ª×•×¦××•×ª: ' + error, 'error');
              showLoading(false);
            }
          })
          .withFailureHandler(function(error) {
            console.error('×©×’×™××” ×‘×˜×¢×™× ×ª ×”××©×™××•×ª:', error);
            showMessage('×©×’×™××” ×‘×˜×¢×™× ×ª ×”××©×™××•×ª ××”×©×¨×ª: ' + error, 'error');
            showLoading(false);
          })
          .loadTasksFromSheet();
      }
      
      // ××ª×—×•×œ ×”×’×¨×¤×™×
      function initializeCharts() {
        // ×’×¨×£ ×”×ª×§×“××•×ª ×©×‘×•×¢×™×ª
        const progressCtx = document.getElementById('progressChart').getContext('2d');
        charts.progress = new Chart(progressCtx, {
          type: 'line',
          data: {
            labels: getLastSevenDays(),
            datasets: [
              {
                label: '××©×™××•×ª ×©×”×•×©×œ××•',
                data: [0, 0, 0, 0, 0, 0, 0],
                borderColor: '#4caf50',
                backgroundColor: 'rgba(76, 175, 80, 0.1)',
                tension: 0.4,
                fill: true
              },
              {
                label: '××©×™××•×ª ×—×“×©×•×ª',
                data: [0, 0, 0, 0, 0, 0, 0],
                borderColor: '#2196f3',
                backgroundColor: 'rgba(33, 150, 243, 0.1)',
                tension: 0.4,
                fill: true
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { position: 'top' },
              title: { display: true, text: '×”×ª×§×“××•×ª ×©×‘×•×¢×™×ª' }
            }
          }
        });
        
        // ×’×¨×£ ×”×ª×¤×œ×’×•×ª ×§×˜×’×•×¨×™×•×ª
        const categoriesCtx = document.getElementById('categoriesChart').getContext('2d');
        charts.categories = new Chart(categoriesCtx, {
          type: 'pie',
          data: {
            labels: ['×›×œ×œ×™', '×¢×‘×•×“×”', '××™×©×™', '×‘×¨×™××•×ª', '×œ×™××•×“×™×'],
            datasets: [{
              data: [0, 0, 0, 0, 0],
              backgroundColor: [
                '#9e9e9e', '#f44336', '#2196f3', '#4caf50', '#ff9800'
              ]
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { position: 'right' },
              title: { display: true, text: '×”×ª×¤×œ×’×•×ª ×œ×¤×™ ×§×˜×’×•×¨×™×•×ª' }
            }
          }
        });
        
        // ×’×¨×£ ×”×ª×¤×œ×’×•×ª ×¢×“×™×¤×•×™×•×ª
        const prioritiesCtx = document.getElementById('prioritiesChart').getContext('2d');
        charts.priorities = new Chart(prioritiesCtx, {
          type: 'bar',
          data: {
            labels: ['× ××•×›×”', '×‘×™× ×•× ×™×ª', '×’×‘×•×”×”'],
            datasets: [{
              label: '×›××•×ª ××©×™××•×ª',
              data: [0, 0, 0],
              backgroundColor: [
                '#81c784', '#ffb74d', '#e57373'
              ]
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              title: { display: true, text: '×”×ª×¤×œ×’×•×ª ×œ×¤×™ ×¢×“×™×¤×•×™×•×ª' }
            }
          }
        });
      }
      
      // ×¢×“×›×•×Ÿ ×”×’×¨×¤×™×
      function updateCharts() {
        // ×¢×“×›×•×Ÿ ×’×¨×£ ×”×ª×§×“××•×ª
        const weekData = getWeekActivityData();
        charts.progress.data.datasets[0].data = weekData.completed;
        charts.progress.data.datasets[1].data = weekData.added;
        charts.progress.update();
        
        // ×¢×“×›×•×Ÿ ×’×¨×£ ×§×˜×’×•×¨×™×•×ª
        const categoryData = getCategoryData();
        charts.categories.data.datasets[0].data = [
          categoryData.general,
          categoryData.work,
          categoryData.personal,
          categoryData.health,
          categoryData.education
        ];
        charts.categories.update();
        
        // ×¢×“×›×•×Ÿ ×’×¨×£ ×¢×“×™×¤×•×™×•×ª
        const priorityData = getPriorityData();
        charts.priorities.data.datasets[0].data = [
          priorityData.low,
          priorityData.medium,
          priorityData.high
        ];
        charts.priorities.update();
      }
      
      // ×¤×•× ×§×¦×™×” ×œ×”×—×œ×¤×” ×‘×™×Ÿ ×’×¨×¤×™×
      function showChart(chartName) {
        // ×¢×“×›×•×Ÿ ×”×›×¤×ª×•×¨×™×
        document.querySelectorAll('.chart-tab').forEach(tab => tab.classList.remove('active'));
        document.querySelector(`.chart-tab:nth-child(${chartName === 'progress' ? 1 : chartName === 'categories' ? 2 : 3})`).classList.add('active');
        
        // ×”×—×œ×¤×ª ×”×’×¨×£ ×”××•×¦×’
        document.getElementById('progressChart').style.display = 'none';
        document.getElementById('categoriesChart').style.display = 'none';
        document.getElementById('prioritiesChart').style.display = 'none';
        document.getElementById(`${chartName}Chart`).style.display = 'block';
        
        activeChart = chartName;
      }
      
      // ×§×‘×œ×ª × ×ª×•× ×™ ×¤×¢×™×œ×•×ª ×©×‘×•×¢×™×ª
      function getWeekActivityData() {
        const dates = getLastSevenDays(true);
        const completed = Array(7).fill(0);
        const added = Array(7).fill(0);
        
        tasks.forEach(task => {
          const taskDate = new Date(task.createdAt).toISOString().split('T')[0];
          const completedDate = task.completed && task.completedAt ? new Date(task.completedAt).toISOString().split('T')[0] : null;
          
          // ×‘×“×™×§×” ×× ×”××©×™××” × ×•×¦×¨×” ×‘×©×‘×•×¢ ×”××—×¨×•×Ÿ
          const addedIndex = dates.indexOf(taskDate);
          if (addedIndex !== -1) {
            added[addedIndex]++;
          }
          
          // ×‘×“×™×§×” ×× ×”××©×™××” ×”×•×©×œ××” ×‘×©×‘×•×¢ ×”××—×¨×•×Ÿ
          if (completedDate) {
            const completedIndex = dates.indexOf(completedDate);
            if (completedIndex !== -1) {
              completed[completedIndex]++;
            }
          }
        });
        
        return { completed, added };
      }
      
      // ×§×‘×œ×ª × ×ª×•× ×™ ×”×ª×¤×œ×’×•×ª ×§×˜×’×•×¨×™×•×ª
      function getCategoryData() {
        const categoryData = {
          general: 0,
          work: 0,
          personal: 0,
          health: 0,
          education: 0
        };
        
        tasks.forEach(task => {
          if (task.category && categoryData.hasOwnProperty(task.category)) {
            categoryData[task.category]++;
          } else {
            categoryData.general++;
          }
        });
        
        return categoryData;
      }
      
      // ×§×‘×œ×ª × ×ª×•× ×™ ×”×ª×¤×œ×’×•×ª ×¢×“×™×¤×•×™×•×ª
      function getPriorityData() {
        const priorityData = {
          low: 0,
          medium: 0,
          high: 0
        };
        
        tasks.forEach(task => {
          if (task.priority && priorityData.hasOwnProperty(task.priority)) {
            priorityData[task.priority]++;
          } else {
            priorityData.medium++;
          }
        });
        
        return priorityData;
      }
      
      // ×¤×•× ×§×¦×™×” ×œ×”×—×–×¨×ª 7 ×”×™××™× ×”××—×¨×•× ×™× ×‘×¤×•×¨××˜ ××ª××™×
      function getLastSevenDays(asISOString = false) {
        const days = [];
        const today = new Date();
        
        for (let i = 6; i >= 0; i--) {
          const date = new Date();
          date.setDate(today.getDate() - i);
          
          if (asISOString) {
            days.push(date.toISOString().split('T')[0]);
          } else {
            days.push(date.toLocaleDateString('he-IL', { day: 'numeric', month: 'numeric' }));
          }
        }
        
        return days;
      }
      
      // ×”×•×¡×¤×ª ××©×™××” ×—×“×©×”
      function addNewTask() {
        const taskInput = document.getElementById('newTaskInput');
        const dateInput = document.getElementById('newTaskDate');
        const prioritySelect = document.getElementById('taskPriority');
        const categorySelect = document.getElementById('taskCategory');
        
        if (taskInput.value.trim() === '') {
          showMessage('× × ×œ×”×–×™×Ÿ ×ª×•×›×Ÿ ×œ××©×™××”', 'error');
          return;
        }
        
        markDataAsChanged(); // ×¡×™××•×Ÿ ×©×”×™×• ×©×™× ×•×™×™×
        
        const newTask = {
          id: Date.now(),
          text: taskInput.value.trim(),
          completed: false,
          date: dateInput.value || null,
          createdAt: new Date().toISOString(),
          priority: prioritySelect.value,
          category: categorySelect.value,
          mood: currentMood
        };
        
        tasks.push(newTask);
        saveTasks(); // ×©××™×¨×” ×œ×©×¨×ª
        
        // × ×§×” ××ª ×”×©×“×•×ª
        taskInput.value = '';
        dateInput.value = '';
        prioritySelect.value = 'medium';
        
        showMessage(`×”××©×™××” "${newTask.text}" × ×•×¡×¤×” ×‘×”×¦×œ×—×”!`, 'success');
      }
      
      // ×¢×“×›×•×Ÿ/×¨×™× ×“×•×¨ ×¨×©×™××ª ×”××©×™××•×ª
      function renderTasks() {
        console.log('renderTasks × ×§×¨××”, ××¢×¨×š ×”××©×™××•×ª:', tasks);
        
        const taskList = document.getElementById('taskList');
        if (!taskList) {
          console.error('×œ× × ××¦× ××œ×× ×˜ taskList');
          return;
        }
        
        taskList.innerHTML = '';
        console.log('× ×•×§×” taskList');
        
        if (isLoading) {
          taskList.innerHTML = '<li class="task-item" style="justify-content: center; color: #888;">×˜×•×¢×Ÿ ××©×™××•×ª...</li>';
          console.log('××¦×‘ ×˜×¢×™× ×”, ××¦×™×’ ×”×•×“×¢×ª ×˜×¢×™× ×”');
          return;
        }
        
        // ×‘×“×™×§×” ×©×™×© ××©×™××•×ª ×‘×›×œ×œ
        if (!tasks || !Array.isArray(tasks) || tasks.length === 0) {
          taskList.innerHTML = '<li class="task-item" style="justify-content: center; color: #888;">××™×Ÿ ××©×™××•×ª ×‘××¢×¨×›×ª</li>';
          console.warn('××™×Ÿ ××©×™××•×ª ×œ×ª×¦×•×’×” ××• ×©×”××©×™××•×ª ××™× ×Ÿ ×‘××‘× ×” ×ª×§×™×Ÿ:', tasks);
          return;
        }
        
        console.log('××¦×™×’ ××©×™××•×ª:', tasks.length);
        
        // ×¡×™× ×•×Ÿ ×”××©×™××•×ª ×œ×¤×™ ×”×¤×™×œ×˜×¨ ×”× ×•×›×—×™ ×•×”×§×˜×’×•×¨×™×•×ª
        const filteredTasks = tasks.filter(task => {
          if (!task || typeof task !== 'object') {
            console.warn('××©×™××” ×œ× ×ª×§×™× ×”:', task);
            return false;
          }
          
          const statusFilter = currentFilter === 'all' ||
                              (currentFilter === 'active' && !task.completed) ||
                              (currentFilter === 'completed' && task.completed);
          
          const categoryFilter = !task.category || selectedCategories.includes(task.category);
          
          return statusFilter && categoryFilter;
        });
        
        console.log('××©×™××•×ª ××—×¨×™ ×¡×™× ×•×Ÿ:', filteredTasks.length);
        
        if (filteredTasks.length === 0) {
          taskList.innerHTML = '<li class="task-item" style="justify-content: center; color: #888;">××™×Ÿ ××©×™××•×ª ×œ×”×¦×’×”</li>';
          console.log('××™×Ÿ ××©×™××•×ª ××—×¨×™ ×”×¡×™× ×•×Ÿ');
          return;
        }
        
        console.log('××ª×—×™×œ ×œ×™×¦×•×¨ ××œ×× ×˜×™× ×¢×‘×•×¨', filteredTasks.length, '××©×™××•×ª');
        
        let elementsCreated = 0;
        filteredTasks.forEach((task, index) => {
          try {
            console.log(`×™×•×¦×¨ ××œ×× ×˜ ×¢×‘×•×¨ ××©×™××” ${index}:`, task.text);
            const listItem = document.createElement('li');
            listItem.className = `task-item ${task.completed ? 'completed' : ''}`;
            listItem.dataset.id = task.id;
            
            let dateText = '';
            if (task.date) {
              const taskDate = new Date(task.date);
              dateText = `<span class="task-date">${taskDate.toLocaleDateString('he-IL')}</span>`;
            }
            
            // ×”×•×¡×¤×ª ×ª×’×™×•×ª
            let tagsHtml = '<div class="task-tags">';
            
            // ×ª×’ ×¢×“×™×¤×•×ª
            if (task.priority) {
              tagsHtml += `<span class="task-tag ${task.priority}">${getPriorityText(task.priority)}</span>`;
            }
            
            // ×ª×’ ×§×˜×’×•×¨×™×”
            if (task.category) {
              tagsHtml += `<span class="task-tag">${getCategoryText(task.category)}</span>`;
            }
            
            // ×ª×’ ××¦×‘ ×¨×•×— (×× ×§×™×™×)
            if (task.mood) {
              tagsHtml += `<span class="task-tag">${task.mood}</span>`;
            }
            
            tagsHtml += '</div>';
            
            listItem.innerHTML = `
              <input type="checkbox" ${task.completed ? 'checked' : ''} onchange="toggleTask(${task.id})">
              <div class="task-content">
                <span>${task.text}</span>
                ${dateText}
                ${tagsHtml}
              </div>
              <div class="task-actions">
                <button onclick="editTask(${task.id})" title="×¢×¨×•×š">âœï¸</button>
                <button onclick="deleteTask(${task.id})" title="××—×§">ğŸ—‘ï¸</button>
              </div>
            `;
            
            taskList.appendChild(listItem);
            elementsCreated++;
            console.log(`××œ×× ×˜ ${index} × ×•×¦×¨ ×‘×”×¦×œ×—×”`);
          } catch (error) {
            console.error(`×©×’×™××” ×‘×™×¦×™×¨×ª ××œ×× ×˜ ×¢×‘×•×¨ ××©×™××” ${index}:`, error, task);
          }
        });
        
        console.log(`×”×•×©×œ××” ×™×¦×™×¨×ª ${elementsCreated} ××œ×× ×˜×™× ××ª×•×š ${filteredTasks.length} ××©×™××•×ª`);
      }
      
      // ×¤×•× ×§×¦×™×” ×œ×”××¨×ª ×¢×¨×š ×¢×“×™×¤×•×ª ×œ×˜×§×¡×˜
      function getPriorityText(priority) {
        switch (priority) {
          case 'low': return '× ××•×›×”';
          case 'medium': return '×‘×™× ×•× ×™×ª';
          case 'high': return '×’×‘×•×”×”';
          default: return '×‘×™× ×•× ×™×ª';
        }
      }
      
      // ×¤×•× ×§×¦×™×” ×œ×”××¨×ª ×¢×¨×š ×§×˜×’×•×¨×™×” ×œ×˜×§×¡×˜
      function getCategoryText(category) {
        switch (category) {
          case 'general': return '×›×œ×œ×™';
          case 'work': return '×¢×‘×•×“×”';
          case 'personal': return '××™×©×™';
          case 'health': return '×‘×¨×™××•×ª';
          case 'education': return '×œ×™××•×“×™×';
          default: return '×›×œ×œ×™';
        }
      }
      
      // ×¡×™××•×Ÿ ××©×™××” ×›×”×•×©×œ××”/×œ× ×”×•×©×œ××”
      function toggleTask(id) {
        const taskIndex = tasks.findIndex(task => task.id === id);
        if (taskIndex !== -1) {
          tasks[taskIndex].completed = !tasks[taskIndex].completed;
          
          // ×”×•×¡×¤×ª ×ª××¨×™×š ×”×©×œ××” ×× ×”××©×™××” ×¡×•×× ×” ×›×”×•×©×œ××”
          if (tasks[taskIndex].completed) {
            tasks[taskIndex].completedAt = new Date().toISOString();
          } else {
            tasks[taskIndex].completedAt = null;
          }
          
          saveTasks(); // ×©××™×¨×” ×œ×©×¨×ª
          
          if (tasks[taskIndex].completed) {
            showMessage('×›×œ ×”×›×‘×•×“! ×”××©×™××” ×”×•×©×œ××”', 'success');
          }
        }
      }
      
      // ×¢×¨×™×›×ª ××©×™××”
      function editTask(id) {
        const task = tasks.find(task => task.id === id);
        if (!task) return;
        
        const newText = prompt('×¢×¨×™×›×ª ××©×™××”:', task.text);
        if (newText !== null && newText.trim() !== '') {
          task.text = newText.trim();
          saveTasks(); // ×©××™×¨×” ×œ×©×¨×ª
          showMessage('×”××©×™××” ×¢×•×“×›× ×” ×‘×”×¦×œ×—×”', 'success');
        }
      }
      
      // ××—×™×§×ª ××©×™××”
      function deleteTask(id) {
        if (confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××©×™××” ×–×•?')) {
          tasks = tasks.filter(task => task.id !== id);
          markDataAsChanged(); // ×¡×™××•×Ÿ ×©×”×™×• ×©×™× ×•×™×™×
          saveTasks(); // ×©××™×¨×” ×œ×©×¨×ª
          showMessage('×”××©×™××” × ××—×§×” ×‘×”×¦×œ×—×”', 'success');
        }
      }
      
      // ×¡×™× ×•×Ÿ ××©×™××•×ª
      function filterTasks(filter) {
        currentFilter = filter;
        
        // ×¢×“×›×•×Ÿ ×›×¤×ª×•×¨×™ ×”×¡×™× ×•×Ÿ
        document.getElementById('filterAll').classList.remove('active');
        document.getElementById('filterActive').classList.remove('active');
        document.getElementById('filterCompleted').classList.remove('active');
        document.getElementById(`filter${filter.charAt(0).toUpperCase() + filter.slice(1)}`).classList.add('active');
        
        renderTasks();
      }
      
      // ×¤×ª×™×—×ª ××•×“×œ ×¡×™× ×•×Ÿ ×œ×¤×™ ×§×˜×’×•×¨×™×”
      function openCategoryFilterModal() {
        document.getElementById('categoryFilterModal').style.display = 'block';
        
        // ×¢×“×›×•×Ÿ ××¦×‘ ×”×¦'×§×‘×•×§×¡×™× ×œ×¤×™ ×”×§×˜×’×•×¨×™×•×ª ×”× ×‘×—×¨×•×ª
        selectedCategories.forEach(category => {
          document.getElementById(`category${category.charAt(0).toUpperCase() + category.slice(1)}`).checked = true;
        });
      }
      
      // ×”×—×œ×ª ×¡×™× ×•×Ÿ ×œ×¤×™ ×§×˜×’×•×¨×™×”
      function applyCategoryFilter() {
        selectedCategories = [];
        
        // ×§×¨×™××ª ×¢×¨×›×™ ×”×¦'×§×‘×•×§×¡×™×
        if (document.getElementById('categoryGeneral').checked) selectedCategories.push('general');
        if (document.getElementById('categoryWork').checked) selectedCategories.push('work');
        if (document.getElementById('categoryPersonal').checked) selectedCategories.push('personal');
        if (document.getElementById('categoryHealth').checked) selectedCategories.push('health');
        if (document.getElementById('categoryEducation').checked) selectedCategories.push('education');
        
        closeModal('categoryFilterModal');
        renderTasks();
        
        showMessage('×”×¡×™× ×•×Ÿ ×”×•×—×œ ×‘×”×¦×œ×—×”', 'success');
      }
      
      // ××—×™×§×ª ×›×œ ×”××©×™××•×ª ×©×”×•×©×œ××•
      function clearCompletedTasks() {
        const completedCount = tasks.filter(task => task.completed).length;
        
        if (completedCount === 0) {
          showMessage('××™×Ÿ ××©×™××•×ª ×©×”×•×©×œ××• ×œ××—×™×§×”', 'error');
          return;
        }
        
        if (confirm(`×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ${completedCount} ××©×™××•×ª ×©×”×•×©×œ××•?`)) {
          tasks = tasks.filter(task => !task.completed);
          saveTasks(); // ×©××™×¨×” ×œ×©×¨×ª
          showMessage('×”××©×™××•×ª ×©×”×•×©×œ××• × ××—×§×• ×‘×”×¦×œ×—×”', 'success');
        }
      }
      
      // ×™×¦×•× ××©×™××•×ª ×œ×§×•×‘×¥
      function saveTasksToFile() {
        if (tasks.length === 0) {
          showMessage('××™×Ÿ ××©×™××•×ª ×œ×™×¦×•×', 'error');
          return;
        }
        
        const taskData = JSON.stringify(tasks, null, 2);
        const blob = new Blob([taskData], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = `tasks-${new Date().toISOString().slice(0, 10)}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        
        showMessage('×”××©×™××•×ª ×™×•×¦××• ×‘×”×¦×œ×—×”', 'success');
      }
      
      // ×¢×“×›×•×Ÿ ×¡×˜×˜×™×¡×˜×™×§×•×ª ××©×™××•×ª
      function updateTaskStats() {
        document.getElementById('totalTasks').textContent = tasks.length;
        document.getElementById('completedTasks').textContent = tasks.filter(task => task.completed).length;
        document.getElementById('pendingTasks').textContent = tasks.filter(task => !task.completed).length;
      }
      
      // ×”×¦×’×ª ×”×•×“×¢×•×ª ××¢×¨×›×ª
      function showMessage(message, type) {
        const messageBox = document.getElementById('messageBox');
        messageBox.textContent = message;
        messageBox.className = `message-box ${type}`;
        messageBox.style.display = 'block';
        
        // ×”×¡×ª×¨×ª ×”×”×•×“×¢×” ×œ××—×¨ 3 ×©× ×™×•×ª
        setTimeout(() => {
          messageBox.style.display = 'none';
        }, 3000);
      }
      
      // ×”×’×“×¨×ª ××¦×‘ ×¨×•×— × ×•×›×—×™
      function setMood(mood) {
        currentMood = mood;
        
        // ×¢×“×›×•×Ÿ ×—×–×•×ª×™
        document.querySelectorAll('.mood-icon').forEach(icon => {
          icon.classList.remove('selected');
        });
        
        // ××¦×™××ª ×”××™×™×§×•×Ÿ ×©× ×œ×—×¥ ×•×”×•×¡×¤×ª ××—×œ×§×ª 'selected'
        Array.from(document.querySelectorAll('.mood-icon')).find(el => el.textContent === mood)?.classList.add('selected');
        
        showMessage(`××¦×‘ ×”×¨×•×— ×¢×•×“×›×Ÿ ×œ: ${mood}`, 'success');
      }
      
      // ×™×¦×™×¨×ª ×”×¦×¢×•×ª ×œ×¤×¢×™×œ×•×™×•×ª ×—×•×–×¨×•×ª
      function populateRecurringTaskSuggestions() {
        const recurringTasksList = document.getElementById('recurringTasksList');
        const suggestions = [
          { icon: 'ğŸƒ', text: '××™××•×Ÿ ×™×•××™', frequency: 'daily', category: 'health' },
          { icon: 'ğŸ“š', text: '×§×¨×™××ª ×¡×¤×¨', frequency: 'daily', category: 'personal' },
          { icon: 'ğŸ§¹', text: '× ×™×§×™×•×Ÿ ×”×‘×™×ª', frequency: 'weekly', category: 'personal' },
          { icon: 'ğŸ’»', text: '×’×™×‘×•×™ ××¡××›×™×', frequency: 'weekly', category: 'work' },
          { icon: 'ğŸ›’', text: '×§× ×™×•×ª ×©×‘×•×¢×™×•×ª', frequency: 'weekly', category: 'personal' },
          { icon: 'ğŸ“Š', text: '×¡×™×›×•× ×—×•×“×©×™', frequency: 'monthly', category: 'work' }
        ];
        
        recurringTasksList.innerHTML = '';
        suggestions.forEach(suggestion => {
          const suggestionItem = document.createElement('div');
          suggestionItem.className = 'recurring-suggestion';
          suggestionItem.innerHTML = `
            <div class="recurring-icon">${suggestion.icon}</div>
            <span>${suggestion.text} (${getFrequencyText(suggestion.frequency)})</span>
            <button class="btn" onclick="addSuggestedRecurringTask('${suggestion.text}', '${suggestion.frequency}', '${suggestion.category}')">×”×•×¡×£</button>
          `;
          recurringTasksList.appendChild(suggestionItem);
        });
      }
      
      // ×”××¨×ª ×ª×“×™×¨×•×ª ×œ×˜×§×¡×˜ ×‘×¢×‘×¨×™×ª
      function getFrequencyText(frequency) {
        switch (frequency) {
          case 'daily': return '×™×•××™';
          case 'weekly': return '×©×‘×•×¢×™';
          case 'monthly': return '×—×•×“×©×™';
          default: return '';
        }
      }
      
      // ×”×•×¡×¤×ª ××©×™××” ×—×•×–×¨×ª ××”×”×¦×¢×•×ª
      function addSuggestedRecurringTask(text, frequency, category) {
        document.getElementById('recurringTaskName').value = text;
        document.getElementById('recurringFrequency').value = frequency;
        document.getElementById('recurringCategory').value = category;
        openRecurringTasksModal();
      }
      
      // ×¤×ª×™×—×ª ××•×“×œ ×¤×¢×™×œ×•×™×•×ª ×—×•×–×¨×•×ª
      function openRecurringTasksModal() {
        document.getElementById('recurringTasksModal').style.display = 'block';
      }
      
      // ×”×•×¡×¤×ª ×¤×¢×™×œ×•×ª ×—×•×–×¨×ª
      function addRecurringTask() {
        const taskName = document.getElementById('recurringTaskName').value.trim();
        const frequency = document.getElementById('recurringFrequency').value;
        const category = document.getElementById('recurringCategory').value;
        
        if (!taskName) {
          showMessage('× × ×œ×”×–×™×Ÿ ×©× ×œ××©×™××”', 'error');
          return;
        }
        
        // ×™×¦×™×¨×ª ××©×™××” ×—×•×–×¨×ª
        const recurringTask = {
          id: Date.now(),
          text: taskName,
          frequency: frequency,
          category: category,
          lastCreated: null
        };
        
        recurringTasks.push(recurringTask);
        
        // ×™×¦×™×¨×ª ×”××©×™××” ×”×¨××©×•× ×” ××”×¤×¢×™×œ×•×ª ×”×—×•×–×¨×ª
        const newTask = {
          id: Date.now() + 1,
          text: `${taskName} (${getFrequencyText(frequency)})`,
          completed: false,
          date: null,
          createdAt: new Date().toISOString(),
          priority: 'medium',
          category: category,
          isRecurring: true,
          recurringId: recurringTask.id
        };
        
        tasks.push(newTask);
        saveTasks(); // ×©××™×¨×” ×œ×©×¨×ª
        
        closeModal('recurringTasksModal');
        showMessage(`×”×¤×¢×™×œ×•×ª ×”×—×•×–×¨×ª "${taskName}" × ×•×¡×¤×” ×‘×”×¦×œ×—×”`, 'success');
      }
      
      // ×¡×’×™×¨×ª ××•×“×œ
      function closeModal(modalId) {
        document.getElementById(modalId).style.display = 'none';
      }
      
      // ×”×•×¡×¤×ª ×›×¤×ª×•×¨ ×¨×¢× ×•×Ÿ ×‘××‘×˜ ×”×¨××©×™
      document.addEventListener('DOMContentLoaded', function() {
        // ×”×•×¡×¤×ª ×›×¤×ª×•×¨ ×¨×¢× ×•×Ÿ ×œ×˜×¢×™× ×ª ××©×™××•×ª ××—×“×©
        const refreshButton = document.createElement('button');
        refreshButton.className = 'btn';
        refreshButton.style.marginRight = '10px';
        refreshButton.innerHTML = 'ğŸ”„ ×¨×¢× ×Ÿ';
        refreshButton.onclick = loadTasks;
        
        // ×”×•×¡×¤×ª ×”×›×¤×ª×•×¨ ×œ×¤× ×™ ×›×¤×ª×•×¨ ×”×™×¦×•×
        document.querySelector('.task-filters').appendChild(refreshButton);
      });
      
      // ×× ×™×¢×ª ××—×™×§×ª × ×ª×•× ×™× ×‘×¢×ª ×¡×’×™×¨×ª ×”×“×£ ×× ××™×Ÿ ×©×™× ×•×™×™×
      let dataChanged = false;
      
      // ×¢×“×›×•×Ÿ ××©×ª× ×” ×”××¡××Ÿ ×× ×”×™×• ×©×™× ×•×™×™× ×‘× ×ª×•× ×™×
      function markDataAsChanged() {
        dataChanged = true;
      }
      
      // ×”×•×¡×¤×ª ×”××–× ×” ×œ××™×¨×•×¢×™× ×©××©× ×™× ××ª ×”× ×ª×•× ×™×
      function addTaskChangeListeners() {
        // ×”×•×¡×¤×ª ×”××–× ×” ×œ×¤×•× ×§×¦×™×•×ª ×©××©× ×•×ª ××ª ×”××©×™××•×ª
        const originalAddNewTask = window.addNewTask;
        window.addNewTask = function() {
          markDataAsChanged();
          return originalAddNewTask.apply(this, arguments);
        };
        
        const originalToggleTask = window.toggleTask;
        window.toggleTask = function() {
          markDataAsChanged();
          return originalToggleTask.apply(this, arguments);
        };
        
        const originalDeleteTask = window.deleteTask;
        window.deleteTask = function() {
          markDataAsChanged();
          return originalDeleteTask.apply(this, arguments);
        };
        
        const originalEditTask = window.editTask;
        window.editTask = function() {
          markDataAsChanged();
          return originalEditTask.apply(this, arguments);
        };
      }
      
      // ×”×¤×¢×œ×ª ×××–×™× ×™ ×”×©×™× ×•×™×™×
      document.addEventListener('DOMContentLoaded', addTaskChangeListeners);
      
      // ×˜×™×¤×•×œ ×‘×¡×’×™×¨×ª ×”×“×£ ××• ×¨×¢× ×•×Ÿ - ×œ× ×œ×©××•×¨ ×× ×œ× ×”×™×• ×©×™× ×•×™×™×
      window.addEventListener('beforeunload', function(e) {
        if (dataChanged && tasks.length > 0) {
          // ×× ×”×™×• ×©×™× ×•×™×™× ×‘× ×ª×•× ×™×, ×™×© ×œ×©××•×¨ ××•×ª×
          console.log('× ×¡×’×¨ ×”×“×£ ×¢× ×©×™× ×•×™×™×, ×©×•××¨ ××ª ×”× ×ª×•× ×™×...');
          
          // ××›×™×•×•×Ÿ ×©××™×¨×•×¢ beforeunload ×œ× ×××¤×©×¨ ×§×¨×™××•×ª ××¡×™× ×›×¨×•× ×™×•×ª,
          // × ×‘×¦×¢ ××ª ×”×©××™×¨×” ×‘××•×¤×Ÿ ×¡×™× ×›×¨×•× ×™ ×× ××¤×©×¨
          try {
            // ××¤×©×¨×•×ª ×œ×¨××– ×œ××©×ª××© ×©×™×© ×©×™× ×•×™×™× ×œ× ×©××•×¨×™×
            e.preventDefault();
            e.returnValue = '';
          } catch (error) {
            console.error('×©×’×™××” ×‘×˜×™×¤×•×œ ×‘×¡×’×™×¨×ª ×“×£:', error);
          }
        } else {
          console.log('× ×¡×’×¨ ×”×“×£ ×œ×œ× ×©×™× ×•×™×™× ×‘× ×ª×•× ×™×');
        }
      });
    </script>
  </body>
</html>